$(function () {

    var bindmaterlpage = function (ele) {
        $('#table_container').html(ele);
        $(".doctables a").live("click", function () {
            if ($(this).attr("href").split('=')[1] == "") {
                $(this).attr("href", $(this).attr("href") + $(this).parents("li").data("id"));
            }
        });
    };


    var SeeMaterialDialog = function (html) {

        if ($('#dlg_invite').length == 0) {
            $('body').append($('<div id="dlg_invite" />'));
        }
        var dlg = $('#dlg_invite').dialog({
            title: "查看素材详情",
            width: 880,
            height: 600,
            modal: false,
            resizable: false,
            autoOpen: false
        }).html(html);
        dlg.dialog("open");
        $('button').button();
    };

    $("#materialpageform").gform({
        onSuccess: function (r) {
            if (!r) {
                alert("发生未知错误");
                return false;
            }
            if (r.code = 1) {
                bindmaterlpage($(r.html));
                var sizes = $("#pagesizes").val();
                $(".sumcount").text(sizes);
            }
            else {
                alert(r.msg);
            }
        }, cb: function (form) {
            $.fn.gform.working = false;
            form.submit();
        }
    });

    //删除全部选择
    $("#Screening").on("click", 'a', function () {

        var classes = $(this).attr("class");
        if (classes == "metext") {
            array_MediaTyle = null;
            $(".media a").removeClass("current");
            $("a[type=mAll]").addClass("current");
            $("input[name=array_media]").val(array_MediaTyle);
        }
        if (classes == "apptext") {
            array_Application = null;
            $(".application a").removeClass("current");
            $("a[type=aall]").addClass("current");
            $("input[name=array_application]").val(array_Application);
        }
        if (classes == "course") {
            array_Course = null;
            $(".course_search a").removeClass("current");
            $("a[type=call]").addClass("current");
            $("input[name=array_course]").val(array_Course);
        }
        $(this).parent().remove();
        Click();
        return false;
    });

    ///点击应用类型
    var array_Application = null;
    $(document).on('click', '.application a', function () {

        var valueOrText = $(this).text();
        ///如果点击全部，该类型的所有条件失效，显示全部信息
        if (valueOrText == "全部") {
            $(".apptext").parent().remove();
            var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" data-id="' + $(this).data("id") + '" class="apptext">应用类型：全部</a></li>';
            $("#Screening").html(len);
            $(".application a").removeClass("current");
            $(this).addClass("current");
            array_Application = null;
            $("input[name=array_application]").val("");
            Click();
            return false;
        }
        //非点击全部按钮
        //第二次点击移除选中状态，移除数组对应元素，重新生成搜索条件
        if ($(this).attr("class") == "current") {

            $(this).removeClass("current");
            //第二次点击移除数组对应的元素
            var newArray_ApplicationTyle = array_Application.split(',');
            for (var i = 0; i < newArray_ApplicationTyle.length; i++) {
                if (newArray_ApplicationTyle[i] == $(this).data("id")) {
                    newArray_ApplicationTyle.splice(i, 1);
                }
            }
            array_Application = newArray_ApplicationTyle.join(",");
            $("input[name=array_application]").val(array_Application);
            Click();
            var application_Numbers = $(".current", $(".application")), new_text = null;
            if (application_Numbers.length == 0) {
                $("a[type=aall]").addClass("current");
                $(".apptext").parent().remove();
                return false;
            }
            for (var i = 0; i < application_Numbers.length; i++) {
                if (new_text == null) {
                    new_text = $(application_Numbers[i]).text()
                } else { new_text += "、" + $(application_Numbers[i]).text() }
            }

            $(".apptext").parent().remove();
            var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="应用类型：' + new_text + '" class="apptext">应用类型： ' + new_text.substr(0, 20) + '  </a></li>';
            $("#Screening").html(len);
            return false;
        }
        //每次点击赋值
        if (array_Application == null) {
            array_Application = $(this).data("id");
        } else {
            array_Application += "," + $(this).data("id");
        }
        $("input[name=array_application]").val(array_Application);
        $(this).addClass("current");
        $("a[type=aall]").removeClass("current");
        if ($(".apptext").length == 0) {

            var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="应用类型：' + $(this).attr("title") + '" class="apptext">应用类型：' + $(this).text() + '</a></li>';
            $("#Screening").html(len);

        } else {
            if ($(".apptext").text().split('：')[1] == "全部") {
                $(".apptext").parent().remove();
                var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="应用类型：' + $(this).attr("title") + '" class="apptext">应用类型：' + $(this).text() + '</a></li>';
                $("#Screening").html(len);
            } else {
                var media_title = $(".apptext").attr("title") + "、" + $(this).attr("title");
                $(".apptext").text(($(".apptext").attr("title") + "、" + $(this).text()).substr(0, 20));
                $(".apptext").attr("title", media_title);
            }
        }
        Click();
        return false;
    });

    ///点击媒体类型
    var array_MediaTyle = null;
    $(document).on('click', '.media a', function () {

        var valueOrText = $(this).text();
        ///如果点击全部，该类型的所有条件失效，显示全部信息
        if (valueOrText == "全部") {

            $(".metext").parent().remove();
            $(".media a").removeClass("current");
            $(this).addClass("current");
            array_MediaTyle = null;
            $("input[name=array_media]").val("");
            Click();
            return false;
        }
        //非点击全部按钮
        //第二次点击移除选中状态，移除数组对应元素，重新生成搜索条件

        if ($(this).attr("class") == "current") {
            $(this).removeClass("current");
            //第二次点击移除数组对应的元素
            var newArray_MediaTyle = array_MediaTyle.split(',');
            for (var i = 0; i < newArray_MediaTyle.length; i++) {
                if (newArray_MediaTyle[i] == $(this).data("id")) {
                    newArray_MediaTyle.splice(i, 1);
                }
            }
            array_MediaTyle = newArray_MediaTyle.join(",");
            $("input[name=array_media]").val(array_MediaTyle);
            Click();
            var media_Numbers = $(".current", $(".media")), new_text = null;
            if (media_Numbers.length == 0) {
                $("a[type=mAll]").addClass("current");
                $(".metext").parent().remove();
                return false;
            }
            for (var i = 0; i < media_Numbers.length; i++) {
                if (new_text == null) {
                    new_text = $(media_Numbers[i]).text()
                } else { new_text += "、" + $(media_Numbers[i]).text() }
            }

            $(".metext").parent().remove();
            var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="媒体类型：' + $.htmlencode(new_text) + '" class="metext">媒体类型： ' + new_text.substr(0, 20) + '  </a></li>';
            $("#Screening").html(len);
            return false;
        }

        //每次点击赋值
        if (array_MediaTyle == null) {
            array_MediaTyle = $(this).data("id");
        } else {
            array_MediaTyle += "," + $(this).data("id");
        }
        $("input[name=array_media]").val(array_MediaTyle);//绑定值到页面
        $(this).addClass("current");
        $("a[type=mAll]").removeClass("current");
        if ($(".metext").length == 0) {
            var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="媒体类型：' + $(this).attr("title") + '" data-id="' + $(this).data("id") + '" class="metext">媒体类型：' + $(this).text() + '</a></li>';
            $("#Screening").html(len);
        } else {
            if ($(".metext").text().split('：')[1] == "全部") {
                $(".metext").parent().remove();
                var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="媒体类型：' + $(this).attr("title") + '" data-id="' + $(this).data("id") + '" class="metext">媒体类型：' + $(this).text() + '</a></li>';
                $("#Screening").html(len);
            } else {
                var media_title = $(".metext").attr("title") + "、" + $(this).attr("title");
                $(".metext").text(($(".metext").attr("title") + "、" + $(this).text()).substr(0, 20));
                $(".metext").attr("title", media_title);
            }
        }
        Click();
        return false;
    });

    //排序
    var orders = null;
    $(document).on('click', '.orders', function () {

        $(this).siblings('a').removeClass('order').removeClass('order desc').addClass("orders");
        if ($(this).attr('class') == 'orders') {
            $(this).addClass("order desc");
            $("input[name=orders]").val($(this).data('value') + ' asc');
            Click();
            return false;
        }

        $(this).removeClass('orders');
        if ($(this).attr('class') == 'order desc') {
            $(this).attr('class', "order");
            $("input[name=orders]").val($(this).data('value') + ' DESC');
            Click();
            $(this).addClass('orders');
            return false;
        }

        if ($(this).attr('class') == 'order') {
            $(this).addClass("order desc");
            $("input[name=orders]").val($(this).data('value') + ' asc');
            Click();
            $(this).addClass('orders');
            return false;
        }
        $(this).addClass('orders');
        return false;
    });

    ///所属课程
    var array_Course = null;
    $(document).on('click', '.course_search a', function () {
        //全部按钮
        if ($(this).text() == "全部") {
            $(".genuscourse a").removeClass("current");
            $(this).addClass("current");
            $(this).parent().siblings().find("a").removeClass("current");
            array_Course = null;
            $("input[name=array_course]").val(array_Course);
            Click();
        } else {
            //第二次点击
            if ($(this).attr("class") == "current") {
                var newArray_Course = array_Course.split(',');
                for (var i = 0; i < newArray_Course.length; i++) {
                    newArray_Course.splice(i, 1);
                }
                array_Course = newArray_Course.join(',');
                $("input[name=array_course]").val(array_Course);
                Click();
                $(this).removeClass("current");
                var media_Numbers = $(".current", $(".course_search")), new_text = null;
                if (media_Numbers.length == 0) {
                    $("a[type=call]").addClass("current");
                    $(".course").parent().remove();
                    return false;
                }
                for (var i = 0; i < media_Numbers.length; i++) {
                    if (new_text == null) {
                        new_text = $(media_Numbers[i]).text()
                    } else { new_text += "、" + $(media_Numbers[i]).text() }
                }

                $(".course").parent().remove();
                //var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="所属课程：' + $.htmlencode(new_text) + '" class="course">所属课程： ' + new_text.substr(0, 20) + '  </a></li>';
                //$("#Screening").html(len);
                return false;
            }
            //每次点击赋值
            array_Course = $(this).data("id");
            $("input[name=array_course]").val(array_Course);
            $(this).parent().siblings().find("a").removeClass("current");
            Click();
            $(this).addClass("current");
            $("a[type=call]").removeClass("current");
            //if ($(".course").length == 0) {
            //    var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="所属课程：' + $.htmlencode($(this).attr("title")) + '" data-id="' + $(this).data("id") + '" class="course">所属课程：' + $.htmlencode($(this).text().substr(0, 20)) + '</a></li>';
            //    $("#Screening").html(len);
            //} else {
            //    if ($(".course").text().split('：')[1] == "全部") {
            //        $(".course").parent().remove();
            //        var len = document.getElementById('Screening').innerHTML += '<li ><a href="#" title="所属课程：' + $.htmlencode($(this).attr("title")) + '" data-id="' + $(this).data("id") + '" class="course">所属课程：' + $.htmlencode($(this).text().substr(0, 20)) + '</a></li>';
            //        $("#Screening").html(len);
            //    } else {
            //        var media_title = $(".course").attr("title") + "、" + $(this).attr("title");
            //        $(".course").text(($(".course").attr("title") + "、" + $(this).text()).substr(0, 20));
            //        $(".course").attr("title", media_title);
            //    }
            //}
        }
        return false;
    });

    ///默认排序
    $(document).on('click', '.course_search a', function () {
        $("input[name=orders]").val("CreateTime DESC");
        Click();
    });

    ///通过素材名称查找
    $(".submitsure").click(function () {
        var docname = $("input[name=materiaName]").val();
        $("input[name=docname]").val(docname);
        Click();
    });
});